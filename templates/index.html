<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-0EWWS1ZZ18"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-0EWWS1ZZ18');
    </script>

    <title>RecipAI - レシピ検索</title>
</head>
<body>
    <div class="container">
        <h1>RecipAI 🍽️</h1>
        <p>食材を入力してレシピを検索！</p>
        
        <input type="text" id="ingredients" placeholder="例: 鶏肉, キャベツ, にんじん">
        
        <div class="select-box">
            <label for="flavor">味付け:</label>
            <div class="multiselect" onclick="toggleDropdown()">
                <div id="selected-values">選択してください</div>
                <div class="dropdown-content" id="dropdown">
                    <label><input type="checkbox" value="普通"> 普通</label>
                    <label><input type="checkbox" value="甘め"> 甘め</label>
                    <label><input type="checkbox" value="辛め"> 辛め</label>
                    <label><input type="checkbox" value="さっぱり"> さっぱり</label>
                    <label><input type="checkbox" value="こってり"> こってり</label>
                    <label><input type="checkbox" value="薄め"> 薄め</label>
                    <label><input type="checkbox" value="濃いめ"> 濃いめ</label>
                </div>
            </div>
            <input type="hidden" id="flavor-input">
        </div>

        <div class="stepper-container">
            <label for="servings">人数:</label>
            <div class="stepper">
                <button type="button" onclick="changeServings(-1)">−</button>
                <input type="text" id="servings" value="3" readonly>
                <button type="button" onclick="changeServings(1)">＋</button>
            </div>
        </div>

        <button onclick="fetchRecipe()">レシピを検索</button>

        <div id="loading" style="display: none; text-align: center; margin-top: 20px;">
            <p>🔄 レシピを検索中…</p>
        </div>

        <div id="recipe-result" class="recipe-box" style="margin-top: 20px;"></div>
        <div class="substitutes-button-container">
            <button id="suggest-substitutes" onclick="fetchSubstitutes()">
                代替品を提案
            </button>
        </div>
        <div id="substitutes-result" class="substitutes-box" style="margin-top: 20px;"></div>
    </div>

    <footer style="width: 100%; margin-top: 50px; padding: 10px; text-align: center; font-size: 12px; color: #666; background: #f8f8f8; border-top: 1px solid #ddd; position: relative; clear: both;">
        <div class="footer-container" style="display: flex; justify-content: center; align-items: center; gap: 20px; font-size: 12px; color: #666; margin-top: 10px;">
            <a href="/privacy" class="policy-link" style="color: #666; text-decoration: none;">プライバシーポリシー</a>
            <span>|</span>
            <p style="margin: 0;">※ 当サイトはAmazonアソシエイト、楽天アフィリエイトを利用しています。</p>
        </div>
    </footer>

    <script>
        async function fetchRecipe() {
            let ingredients = document.getElementById("ingredients").value.trim();
            let flavor = Array.from(document.querySelectorAll("input[type='checkbox']:checked")).map(el => el.value);
            let servings = document.getElementById("servings").value;
    
            if (!ingredients) {
                alert("食材を入力してください！");
                return;
            }
    
            // ローディング表示
            document.getElementById("loading").style.display = "block";
            document.getElementById("recipe-result").innerHTML = "<h2>レシピ</h2><p></p>"; // クリア
            document.getElementById("substitutes-result").innerHTML = ""; // クリア
            document.getElementById("suggest-substitutes").style.display = "none"; // 代替品ボタン非表示
    
            try {
                let response = await fetch("/get_recipe", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ ingredients, flavor, servings })
                });
    
                if (!response.body) {
                    throw new Error("ストリーミングデータがありません");
                }
    
                // ストリームを受け取る
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let resultContainer = document.querySelector("#recipe-result p");
    
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    resultContainer.innerText += decoder.decode(value, { stream: true });
                }
    
                // ローディング非表示 & 代替品ボタン表示
                document.getElementById("loading").style.display = "none";
                document.getElementById("suggest-substitutes").style.display = "block";

    
            } catch (error) {
                document.getElementById("loading").style.display = "none";
                alert("レシピを取得できませんでした: " + error.message);
            }
        }
    
        async function fetchSubstitutes() {
            let recipeText = document.querySelector("#recipe-result p").innerText.trim();
    
            if (!recipeText) {
                alert("先にレシピを生成してください！");
                return;
            }
    
            document.getElementById("substitutes-result").innerHTML = "<h2>代替品</h2><p></p>"; // クリア
            document.getElementById("suggest-substitutes").disabled = true; // ボタンを一時無効化
    
            try {
                let response = await fetch("/get_substitutes", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ recipe: recipeText })
                });
    
                if (!response.body) {
                    throw new Error("ストリーミングデータがありません");
                }
    
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let resultContainer = document.querySelector("#substitutes-result p");
    
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    resultContainer.innerText += decoder.decode(value, { stream: true });
                }
    
            } catch (error) {
                alert("代替品を取得できませんでした: " + error.message);
            } finally {
                document.getElementById("suggest-substitutes").disabled = false; // ボタンを再有効化
            }
        }
    
        function changeServings(amount) {
            let input = document.getElementById("servings");
            let value = parseInt(input.value, 10);
            value += amount;
            if (value < 1) value = 1;
            if (value > 10) value = 10;
            input.value = value;
        }
    
        function toggleDropdown() {
            let dropdown = document.getElementById("dropdown");
            dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
        }
    
        document.querySelectorAll(".dropdown-content input").forEach(input => {
            input.addEventListener("change", function() {
                let selectedValues = [];
                document.querySelectorAll(".dropdown-content input:checked").forEach(checked => {
                    selectedValues.push(checked.value);
                });
    
                document.getElementById("selected-values").textContent = selectedValues.length > 0 
                    ? selectedValues.join(", ") 
                    : "選択してください";
                document.getElementById("flavor-input").value = selectedValues.join(",");
            });
        });
    
        document.addEventListener("click", function(event) {
            let multiselect = document.querySelector(".multiselect");
            let dropdown = document.getElementById("dropdown");
    
            if (!multiselect.contains(event.target)) {
                dropdown.style.display = "none";
            }
        });
    </script>

</body>
</html>
