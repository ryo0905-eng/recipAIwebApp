<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-0EWWS1ZZ18"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-0EWWS1ZZ18');
    </script>

    <title>RecipAI - ãƒ¬ã‚·ãƒ”æ¤œç´¢</title>
</head>
<body>
    <div class="container">
        <h1>RecipAI ğŸ½ï¸</h1>
        <p>é£Ÿæã‚’å…¥åŠ›ã—ã¦ãƒ¬ã‚·ãƒ”ã‚’æ¤œç´¢ï¼</p>
        
        <input type="text" id="ingredients" placeholder="ä¾‹: é¶è‚‰, ã‚­ãƒ£ãƒ™ãƒ„, ã«ã‚“ã˜ã‚“">
        
        <div class="select-box">
            <label for="flavor">å‘³ä»˜ã‘:</label>
            <div class="multiselect" onclick="toggleDropdown()">
                <div id="selected-values">é¸æŠã—ã¦ãã ã•ã„</div>
                <div class="dropdown-content" id="dropdown">
                    <label><input type="checkbox" value="æ™®é€š"> æ™®é€š</label>
                    <label><input type="checkbox" value="ç”˜ã‚"> ç”˜ã‚</label>
                    <label><input type="checkbox" value="è¾›ã‚"> è¾›ã‚</label>
                    <label><input type="checkbox" value="ã•ã£ã±ã‚Š"> ã•ã£ã±ã‚Š</label>
                    <label><input type="checkbox" value="ã“ã£ã¦ã‚Š"> ã“ã£ã¦ã‚Š</label>
                    <label><input type="checkbox" value="è–„ã‚"> è–„ã‚</label>
                    <label><input type="checkbox" value="æ¿ƒã„ã‚"> æ¿ƒã„ã‚</label>
                </div>
            </div>
            <input type="hidden" id="flavor-input">
        </div>

        <div class="stepper-container">
            <label for="servings">äººæ•°:</label>
            <div class="stepper">
                <button type="button" onclick="changeServings(-1)">âˆ’</button>
                <input type="text" id="servings" value="3" readonly>
                <button type="button" onclick="changeServings(1)">ï¼‹</button>
            </div>
        </div>

        <button onclick="fetchRecipe()">ãƒ¬ã‚·ãƒ”ã‚’æ¤œç´¢</button>

        <div id="loading" style="display: none; text-align: center; margin-top: 20px;">
            <p>ğŸ”„ ãƒ¬ã‚·ãƒ”ã‚’æ¤œç´¢ä¸­â€¦</p>
        </div>

        <div id="recipe-result" class="recipe-box" style="margin-top: 20px;"></div>
        <div class="substitutes-button-container">
            <button id="suggest-substitutes" onclick="fetchSubstitutes()">
                ä»£æ›¿å“ã‚’ææ¡ˆ
            </button>
        </div>
        <div id="substitutes-result" class="substitutes-box" style="margin-top: 20px;"></div>
    </div>

    <footer style="width: 100%; margin-top: 50px; padding: 10px; text-align: center; font-size: 12px; color: #666; background: #f8f8f8; border-top: 1px solid #ddd; position: relative; clear: both;">
        <div class="footer-container" style="display: flex; justify-content: center; align-items: center; gap: 20px; font-size: 12px; color: #666; margin-top: 10px;">
            <a href="/privacy" class="policy-link" style="color: #666; text-decoration: none;">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>
            <span>|</span>
            <p style="margin: 0;">â€» å½“ã‚µã‚¤ãƒˆã¯Amazonã‚¢ã‚½ã‚·ã‚¨ã‚¤ãƒˆã€æ¥½å¤©ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚</p>
        </div>
    </footer>

    <script>
        async function fetchRecipe() {
            let ingredients = document.getElementById("ingredients").value.trim();
            let flavor = Array.from(document.querySelectorAll("input[type='checkbox']:checked")).map(el => el.value);
            let servings = document.getElementById("servings").value;
    
            if (!ingredients) {
                alert("é£Ÿæã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼");
                return;
            }
    
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            document.getElementById("loading").style.display = "block";
            document.getElementById("recipe-result").innerHTML = "<h2>ãƒ¬ã‚·ãƒ”</h2><p></p>"; // ã‚¯ãƒªã‚¢
            document.getElementById("substitutes-result").innerHTML = ""; // ã‚¯ãƒªã‚¢
            document.getElementById("suggest-substitutes").style.display = "none"; // ä»£æ›¿å“ãƒœã‚¿ãƒ³éè¡¨ç¤º
    
            try {
                let response = await fetch("/get_recipe", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ ingredients, flavor, servings })
                });
    
                if (!response.body) {
                    throw new Error("ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
                }
    
                // ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’å—ã‘å–ã‚‹
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let resultContainer = document.querySelector("#recipe-result p");
    
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    resultContainer.innerText += decoder.decode(value, { stream: true });
                }
    
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤º & ä»£æ›¿å“ãƒœã‚¿ãƒ³è¡¨ç¤º
                document.getElementById("loading").style.display = "none";
                document.getElementById("suggest-substitutes").style.display = "block";

    
            } catch (error) {
                document.getElementById("loading").style.display = "none";
                alert("ãƒ¬ã‚·ãƒ”ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ: " + error.message);
            }
        }
    
        async function fetchSubstitutes() {
            let recipeText = document.querySelector("#recipe-result p").innerText.trim();
    
            if (!recipeText) {
                alert("å…ˆã«ãƒ¬ã‚·ãƒ”ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼");
                return;
            }
    
            document.getElementById("substitutes-result").innerHTML = "<h2>ä»£æ›¿å“</h2><p></p>"; // ã‚¯ãƒªã‚¢
            document.getElementById("suggest-substitutes").disabled = true; // ãƒœã‚¿ãƒ³ã‚’ä¸€æ™‚ç„¡åŠ¹åŒ–
    
            try {
                let response = await fetch("/get_substitutes", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ recipe: recipeText })
                });
    
                if (!response.body) {
                    throw new Error("ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
                }
    
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let resultContainer = document.querySelector("#substitutes-result p");
    
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    resultContainer.innerText += decoder.decode(value, { stream: true });
                }
    
            } catch (error) {
                alert("ä»£æ›¿å“ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ: " + error.message);
            } finally {
                document.getElementById("suggest-substitutes").disabled = false; // ãƒœã‚¿ãƒ³ã‚’å†æœ‰åŠ¹åŒ–
            }
        }
    
        function changeServings(amount) {
            let input = document.getElementById("servings");
            let value = parseInt(input.value, 10);
            value += amount;
            if (value < 1) value = 1;
            if (value > 10) value = 10;
            input.value = value;
        }
    
        function toggleDropdown() {
            let dropdown = document.getElementById("dropdown");
            dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
        }
    
        document.querySelectorAll(".dropdown-content input").forEach(input => {
            input.addEventListener("change", function() {
                let selectedValues = [];
                document.querySelectorAll(".dropdown-content input:checked").forEach(checked => {
                    selectedValues.push(checked.value);
                });
    
                document.getElementById("selected-values").textContent = selectedValues.length > 0 
                    ? selectedValues.join(", ") 
                    : "é¸æŠã—ã¦ãã ã•ã„";
                document.getElementById("flavor-input").value = selectedValues.join(",");
            });
        });
    
        document.addEventListener("click", function(event) {
            let multiselect = document.querySelector(".multiselect");
            let dropdown = document.getElementById("dropdown");
    
            if (!multiselect.contains(event.target)) {
                dropdown.style.display = "none";
            }
        });
    </script>

</body>
</html>
